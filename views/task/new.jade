extends ../layout

block append scripts
	:coffeescript
		jQuery ($)->
			$fileList = $ '.fileList'
			$dropzone = $ '.dropzone'
			$hiddenFile = $ '.hiddenFile', $dropzone


			addFiles = ( evt, files ) ->
				console.log evt
				console.log files
				for file in files
					fileList = $dropzone.data( 'fileList' ) || {}
					if !fileList[ file.name ]
						fileList[ file.name ] = file
						$li = $ '<li>',
							text: "#{file.name} (#{file.type})"
						$fileList.append $li
						$dropzone.data 'fileList', fileList
					else
						alert "'#{file.name}'' already present!"
				return
			
			$dropzone.on 'fileReady', addFiles

			$( '#btnSend' ).click ->
				$form = $ 'form'
				fileList = $dropzone.data( 'fileList' ) || {}
				if $.isEmptyObject( fileList )
					alert 'Selezionare almeno 1 file'
				else
					formData = new FormData $form[ 0 ]
					$.each fileList, ( fileID, file )->
						formData.append fileID, file

					xhr = new XMLHttpRequest()
					xhr.open $form.prop( 'method' ), $form.prop( 'action' ), true
					xhr.setRequestHeader "X-Requested-With", "XMLHttpRequest"
					xhr.onprogress = ( evt ) ->
						console.log 'Progresso: '+parseInt evt.position/evt.total*100
					xhr.onload = ( evt ) ->
						location.href = evt.originalTarget.responseText
						return
					xhr.send formData

				return false
block content
	h1 #{title}
	form(action="/task/#{taskID}/code",method="post",enctype="multipart/form-data")
		label(for="name") Insert code instance name: 
		input#name(name="name",placeholder="Insert name")
		div.dropzone Click or drop files here
		ul.fileList
		section.actions
			// input#btnAdd(type="button", value="Add file")
			input#btnSend(type="submit", value="Send")