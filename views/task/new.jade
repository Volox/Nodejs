extends ../layout

block append scripts
	:coffeescript
		jQuery ($)->
			$fileList = $ '.fileList'
			$dropzone = $ '.dropzone'
			$hiddenFile = $ '.hiddenFile', $dropzone


			addFiles = ( evt, files ) ->
				console.log evt
				console.log files
				for file in files
					fileList = $dropzone.data( 'fileList' ) || {}
					if !fileList[ file.name ]
						fileList[ file.name ] = file
						$dt = $ '<dt>',
							text: "#{file.name}"
						$dd = $ '<dd>',
							text: "#{file.type}"
						$fileList.append $dt
						$fileList.append $dd
						$dropzone.data 'fileList', fileList
					else
						alert "'#{file.name}'' already present!"
				return
			
			$dropzone.on 'fileReady', addFiles

			$( '#btnSend' ).click ->
				$form = $ 'form'
				fileList = $dropzone.data( 'fileList' ) || {}
				if $.isEmptyObject( fileList )
					alert 'Select al least 1 file'
				else
					formData = new FormData $form[ 0 ]
					$.each fileList, ( fileID, file )->
						formData.append fileID, file

					xhr = new XMLHttpRequest()
					xhr.open $form.prop( 'method' ), $form.prop( 'action' ), true
					xhr.setRequestHeader "X-Requested-With", "XMLHttpRequest"
					xhr.onprogress = ( evt ) ->
						console.log 'Progresso: '+parseInt evt.position/evt.total*100
					xhr.onload = ( evt ) ->
						location.href = evt.originalTarget.responseText
						return
					xhr.send formData

				return false
block content
	form.form-horizontal(action="/task/#{taskID}/code",method="post",enctype="multipart/form-data")
		.control-group
			label.control-label(for="name") Insert code instance name: 
			.controls
				input.input-xlarge#name(type="text",name="name",placeholder="Insert name")
				p.help-block Insert the name
		
		
		div.dropzone Click or drop files here
		dl.fileList.dl-horizontal


		button.btn.btn-primary#btnSend(type="submit")
			i.icon-ok.icon-white
			|  Send
		button.btn#btnCancel(type="reset")
			i.icon-refresh
			|  Reset